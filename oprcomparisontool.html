<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team OPR Comparison</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #121212;
            color: #e0e0e0;
        }
        .container {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        h1 {
            color: #e0e0e0;
            text-align: center;
        }
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        .control-group {
            flex: 1;
            min-width: 200px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #e0e0e0;
        }
        select, input, button {
            width: 100%;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 4px;
            font-size: 16px;
            background-color: #2a2a2a;
            color: #e0e0e0;
        }
        button {
            background-color: #6c00ab;
            color: white;
            cursor: pointer;
            border: none;
            font-weight: bold;
        }
        button:hover {
            background-color: #8400d1;
        }
        #comparison-container {
            margin-top: 30px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #aaa;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        .team-row {
            display: flex;
            margin-bottom: 10px;
            align-items: center;
            background-color: #252525;
        }
        .team-rank {
            width: 40px;
            font-weight: bold;
            text-align: center;
        }
        .team-number {
            width: 80px;
            font-weight: bold;
        }
        .team-name {
            flex: 1;
        }
        .team-opr {
            width: 80px;
            text-align: right;
            font-weight: bold;
        }
        .opr-bar-container {
            flex: 2;
            background-color: #333;
            height: 20px;
            margin: 0 20px;
            border-radius: 10px;
            overflow: hidden;
        }
        .opr-bar {
            height: 100%;
            background-color: #a200ff;
            border-radius: 10px;
        }
        .highlighted {
            background-color: #3a2840;
            border-radius: 5px;
            padding: 5px;
        }
        .team-list {
            max-height: 600px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 5px;
        }
        .stats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            flex: 1;
            min-width: 200px;
            background-color: #252525;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #a200ff;
            margin: 10px 0;
        }
        .stat-label {
            font-size: 14px;
            color: #aaa;
        }
        .error-message {
            color: #ff9494;
            padding: 10px;
            background-color: #3a1c1c;
            border-radius: 5px;
            margin: 10px 0;
        }
        .team-row.header {
            font-weight: bold;
            background-color: #333;
            border-bottom: 2px solid #444;
            padding: 10px 0;
        }
        
        .team-location {
            flex: 1;
            font-size: 0.9em;
            color: #aaa;
            margin-right: 10px;
        }
        
        /* Make the team list more compact */
        .team-row {
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }
        
        /* Add hover effect */
        .team-row:hover:not(.header) {
            background-color: #2a2a2a;
        }
        
        /* Make the highlighted row more visible */
        .highlighted {
            background-color: #3a2257 !important;
            border-radius: 5px;
            padding: 5px;
            border-left: 3px solid #a200ff;
        }
        .fallback-btn {
            margin-top: 15px;
            background-color: #444;
            color: white;
            padding: 8px 15px;
        }
        .fallback-btn:hover {
            background-color: #555;
        }
        .test-data-notice {
            background-color: #3a2840;
            color: #c9addb;
            padding: 10px;
            margin-top: 20px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        .team-search-controls {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            max-width: 500px;
        }
        .search-group {
            display: flex;
        }
        .compact-btn {
            padding: 3px 8px;
            height: 28px;
            margin: 0 2px;
        }
        #team-search {
            width: 100px;
            margin-right: 5px;
            height: 28px;
        }
        .my-team-summary {
            display: flex;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        .stat-box {
            background: #252525;
            border: 1px solid #333;
            padding: 10px;
            margin-right: 10px;
            margin-bottom: 10px;
            min-width: 100px;
            text-align: center;
        }
        .stat-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #a200ff;
        }
        .full-width {
            width: 100%;
        }
        .pagination {
            text-align: center;
            margin: 15px 0;
        }
        .pagination span {
            color: #e0e0e0;
        }
        #page-input {
            width: 40px;
            text-align: center;
            padding: 3px;
            height: 24px;
        }
        .search-controls {
            margin: 15px 0;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .teams-list {
            background-color: #1e1e1e;
            border: 1px solid #333;
            border-radius: 0 0 4px 4px;
        }
        .team-list-header {
            background-color: #333;
            color: #e0e0e0;
        }
        .region-filter {
            margin: 10px 0;
            display: flex;
            justify-content: center;
            gap: 10px;
            align-items: center;
            color: #e0e0e0;
        }
        #region-select {
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #444;
        }
        .note {
            color: #aaa;
        }
        progress {
            -webkit-appearance: none;
            appearance: none;
            background-color: #333;
            border: none;
            border-radius: 4px;
            height: 8px;
        }
        progress::-webkit-progress-bar {
            background-color: #333;
            border-radius: 4px;
        }
        progress::-webkit-progress-value {
            background-color: #a200ff;
            border-radius: 4px;
        }
        progress::-moz-progress-bar {
            background-color: #a200ff;
            border-radius: 4px;
        }
        @keyframes fadeIn {
            from { opacity: 0; background-color: #3a2840; }
            to { opacity: 1; background-color: #252525; }
        }
        .team-row.new-team {
            animation: fadeIn 0.5s ease-out;
        }
        #teams-list-live {
            background-color: #1e1e1e;
            border: 1px solid #333;
            border-radius: 0 0 4px 4px;
        }
        /* Fix region dropdown width */
        #region-filter {
            min-width: 120px;
            max-width: 250px;
            height: 28px;
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 4px;
            overflow: visible;
            padding: 0 5px;
            margin-left: 10px;
            appearance: menulist; /* Standard property */
            -webkit-appearance: menulist; /* For WebKit browsers */
            -moz-appearance: menulist; /* For Firefox */
        }
        
        #region-filter option {
            padding: 6px;
            background-color: #2a2a2a;
            color: #e0e0e0;
            height: auto;
            min-height: 24px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Team OPR Comparison</h1>
        
        <div class="controls">
            <div class="control-group">
                <label for="season">Season:</label>
                <select id="season">
                    <option value="2024" selected>2024 (INTO THE DEEP)</option>
                    <option value="2023">2023 (CENTERSTAGE)</option>
                    <option value="2022">2022 (POWERPLAY)</option>
                    <option value="2021">2021 (FREIGHT FRENZY)</option>
                    <option value="2019">2020 (ULTIMATE GOAL)</option>
                    <option value="2019">2019 (SKYSTONE)</option>
                </select>
            </div>
            <div class="control-group">
                <button id="compare-btn">Compare Teams</button>
            </div>
        </div>
        
        <div id="comparison-container">
            <p>Select options above and click "Compare Teams" to see how Team 5356 ranks against other teams.</p>
        </div>
    </div>

    <script>
        // Constants
        const MY_TEAM_NUMBER = 5356;
        const FTC_API_BASE_URL = 'https://ftc-events.firstinspires.org/v2.0';
        const API_BASE_URL = 'https://api.ftcscout.org/rest/v1';
        
        // IMPORTANT: In a production app, you should NEVER include your auth token in client-side code
        // This is for demonstration purposes only - in production, use a backend proxy
        const FTC_AUTH_TOKEN = 'A3E13F35-4DB2-44CA-A8D2-BBB405896D62';
        
        // Elements
        const seasonSelect = document.getElementById('season');
        const compareBtn = document.getElementById('compare-btn');
        const comparisonContainer = document.getElementById('comparison-container');
        
        // Event listeners
        compareBtn.addEventListener('click', compareTeams);
        
        // Add this debug function
        function debugLog(message, data) {
            console.log(message);
            if (data) {
                console.log(data);
            }
            
            // Also display in the UI for users who don't have console open
            const debugDiv = document.createElement('div');
            debugDiv.className = 'debug-log';
            debugDiv.style.fontSize = '12px';
            debugDiv.style.fontFamily = 'monospace';
            debugDiv.style.padding = '5px';
            debugDiv.style.margin = '5px 0';
            debugDiv.style.backgroundColor = '#252525';
            debugDiv.style.border = '1px solid #444';
            debugDiv.style.color = '#e0e0e0';
            debugDiv.textContent = message;
            comparisonContainer.appendChild(debugDiv);
        }

        // Display team comparison with centered UI, smaller buttons, and region sorting
        function displayTeamComparison(teams, myTeamNumber, eventName) {
            // Get the teams with the highest OPR
            const sortedTeams = [...teams].sort((a, b) => {
                if (!a.stats.hasRealData && !b.stats.hasRealData) return 0;
                if (!a.stats.hasRealData) return 1;
                if (!b.stats.hasRealData) return -1;
                return b.stats.opr - a.stats.opr;
            });
            
            // Set up pagination
            const teamsPerPage = 20;
            let currentPage = 1;
            let currentTeams = sortedTeams;
            
            // Calculate max OPR for scaling the bars
            const maxOPR = Math.max(...sortedTeams.filter(t => t.stats.hasRealData).map(t => t.stats.opr));
            
            // Find my team's rank
            const myTeamIndex = sortedTeams.findIndex(t => t.number === myTeamNumber);
            const myTeamRank = myTeamIndex !== -1 ? myTeamIndex + 1 : 'N/A';
            const myTeam = sortedTeams.find(t => t.number === myTeamNumber) || { 
                number: myTeamNumber, 
                name: 'TARDIS', 
                stats: { opr: 0, hasRealData: false }
            };
            
            // Generate the HTML for the region dropdown - ONLY use the region codes
            const regionCodes = Array.from(new Set(teams
                .filter(t => t.state && t.state.length)
                .map(t => {
                    // This will get the state abbreviation like WA, TX, etc.
                    const stateParts = t.state.split(',');
                    // Most FTC locations use format "City, ST, Country" - so take the middle part if available
                    return stateParts.length > 1 ? stateParts[1].trim() : stateParts[0].trim();
                })
                .filter(code => code.length > 0 && code.length <= 3))) // Only keep short codes
                .sort();
                
            const countryCodes = Array.from(new Set(teams
                .filter(t => t.country && t.country !== 'USA' && t.country.length <= 3)
                .map(t => t.country.trim())))
                .sort();
            
            // Generate the HTML with proper formatting and clear indication of pagination
            const html = `
                <style>
                    /* Fix centering issues */
                    .my-team-summary {
                        display: flex;
                        flex-wrap: wrap;
                        gap: 10px;
                        margin-bottom: 20px;
                        justify-content: center;
                    }
                    .stat-box {
                        border: 1px solid #444;
                        border-radius: 4px;
                        padding: 10px;
                        background-color: #252525 !important;
                        min-width: 120px;
                        text-align: center;
                        color: #e0e0e0;
                    }
                    .search-controls {
                        margin: 15px 0;
                        display: flex;
                        justify-content: center;
                        gap: 10px;
                        align-items: center;
                    }
                    #team-search {
                        width: 100px;
                        padding: 5px;
                        text-align: center;
                        background-color: #2a2a2a;
                        color: white;
                        border: 1px solid #444;
                        border-radius: 4px;
                    }
                    
                    /* Restore table header styling */
                    .team-list-header {
                        display: flex;
                        font-weight: bold;
                        background-color: #333;
                        padding: 8px 10px;
                        border-radius: 4px 4px 0 0;
                        border: 1px solid #444;
                        color: #e0e0e0;
                    }
                    .header-rank, .team-rank { width: 50px; }
                    .header-number, .team-number { width: 80px; }
                    .header-name, .team-name { flex: 1; }
                    .header-location, .team-location { flex: 1; }
                    .header-opr, .team-opr { width: 60px; text-align: right; }
                    .header-bar, .opr-bar-container { flex: 2; margin: 0 20px; }
                    
                    /* Team rows styling */
                    .teams-list {
                        border: 1px solid #444;
                        border-top: none;
                        border-radius: 0 0 4px 4px;
                        overflow: hidden;
                    }
                    .team-row {
                        display: flex;
                        padding: 8px 10px;
                        border-bottom: 1px solid #333;
                        align-items: center;
                    }
                    .team-row:last-child {
                        border-bottom: none;
                    }
                    .team-row:hover {
                        background-color: #2a2a2a;
                    }
                    .team-row.highlighted {
                        background-color: #3a2257;
                        border-left: 3px solid #a200ff;
                    }
                    .note {
                        text-align: center;
                        font-size: 0.9rem;
                        color: #aaa;
                    }
                    
                    /* Fix pagination styling */
                    .pagination {
                        text-align: center;
                        margin: 15px 0;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        gap: 10px;
                    }
                    .pagination span {
                        color: #e0e0e0;
                        display: inline-flex;
                        align-items: center;
                    }
                    #page-input {
                        width: 40px;
                        text-align: center;
                        background: #2a2a2a;
                        color: #e0e0e0;
                        border: 1px solid #444;
                        border-radius: 3px;
                        padding: 3px;
                        margin: 0 5px;
                    }
                    .compact-btn {
                        padding: 3px 8px;
                        background-color: #6c00ab;
                        color: white;
                        border: none;
                        border-radius: 3px;
                        cursor: pointer;
                        font-size: 0.9em;
                        height: auto;
                        width: auto;
                    }
                    .compact-btn:hover {
                        background-color: #8400d1;
                    }
                    
                    /* Progress bar styling */
                    progress {
                        -webkit-appearance: none;
                        appearance: none;
                        background-color: #333;
                        border: none;
                        border-radius: 4px;
                        height: 8px;
                    }
                    progress::-webkit-progress-bar {
                        background-color: #333;
                        border-radius: 4px;
                    }
                    progress::-webkit-progress-value {
                        background-color: #a200ff;
                        border-radius: 4px;
                    }
                    progress::-moz-progress-bar {
                        background-color: #a200ff;
                        border-radius: 4px;
                    }
                </style>
                    
                    <div class="my-team-summary">
                        <div class="stat-box">
                            <div class="stat-label">Team</div>
                            <div class="stat-value">${myTeam.number}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Name</div>
                            <div class="stat-value">${myTeam.name}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">OPR</div>
                            <div class="stat-value">${myTeam.stats.hasRealData ? myTeam.stats.opr.toFixed(1) : 'N/A'}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Rank</div>
                            <div class="stat-value">${myTeam.stats.hasRealData ? `${myTeamRank} of ${sortedTeams.length}` : 'N/A'}</div>
                        </div>
                    </div>
                    
                    <div class="search-controls">
                    <input type="number" id="team-search" placeholder="Team #" style="width: 100px;">
                    <button id="search-btn" class="compact-btn">Find Team</button>
                        <button id="jump-to-my-team" class="compact-btn">Jump to ${myTeamNumber}</button>
                        
                        <select id="region-filter">
                            <option value="">All Regions</option>
                            <optgroup label="United States">
                                ${regionCodes
                                    .map(code => `<option value="${code}">${code}</option>`)
                                    .join('')}
                            </optgroup>
                            <optgroup label="International">
                                ${countryCodes
                                    .map(code => `<option value="${code}">${code}</option>`)
                                    .join('')}
                            </optgroup>
                        </select>
                    </div>
                    
                    <div class="team-list-header">
                        <div class="header-rank">Rank</div>
                    <div class="header-number">Team</div>
                        <div class="header-name">Name</div>
                        <div class="header-location">Location</div>
                        <div class="header-opr">OPR</div>
                    <div class="header-bar">Performance</div>
                    </div>
                
                    <div class="teams-list" id="teams-list"></div>
                
                <div class="pagination">
                        <button id="prev-page" class="compact-btn">&laquo; Prev</button>
                        <span>Page <input type="number" id="page-input" min="1" value="1"> of&nbsp;<span id="total-pages">1</span></span>
                        <button id="next-page" class="compact-btn">Next &raquo;</button>
                </div>
                
                <p class="note">Note: Teams without OPR data are not shown</p>
                
                <div style="text-align: center; margin-top: 20px;">
                    ${!window.isLoadingTeams ? `
                            <button id="load-more-teams" class="compact-btn" style="padding:8px 15px; background-color: #006b3a;">
                            Load More Teams
                        </button>
                        <p class="load-more-note">
                            <small>Currently showing ${teams.length} of 16,100 teams. Loading more teams will improve search results.</small>
                        </p>
                    ` : ''}
                </div>
            `;
            
            comparisonContainer.innerHTML = html;
            
            // Function to render a team row with ID for each
            function renderTeamRow(team, index) {
                const isMyTeam = team.number === myTeamNumber;
                const rank = index + 1;
                const hasRealData = team.stats.hasRealData;
                const opr = hasRealData ? team.stats.opr.toFixed(1) : 'N/A';
                const percentage = hasRealData ? ((team.stats.opr / maxOPR) * 100) : 0;
                
                const location = [team.city, team.state, team.country].filter(Boolean).join(', ');
                
                return `
                    <div class="team-row ${isMyTeam ? 'highlighted' : ''}" 
                        id="team-row-${team.number}" 
                        data-team="${team.number}">
                        <div class="team-rank">${rank}</div>
                        <div class="team-number">#${team.number}</div>
                        <div class="team-name">${team.name}</div>
                        <div class="team-location">${location}</div>
                        <div class="team-opr">${opr}</div>
                        <div class="opr-bar-container">
                            <div class="opr-bar" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }
            
            // Function to show a specific page of teams
            function showTeamPage(page) {
                const startIndex = (page - 1) * teamsPerPage;
                const endIndex = startIndex + teamsPerPage;
                const teamsToShow = currentTeams.slice(startIndex, endIndex);
                
                const teamsListEl = document.getElementById('teams-list');
                teamsListEl.innerHTML = teamsToShow.map((team, idx) => 
                    renderTeamRow(team, startIndex + idx)).join('');
                
                document.getElementById('page-input').value = page;
                currentPage = page;
            }
            
            // Set up pagination controls
            const totalPages = Math.ceil(currentTeams.length / teamsPerPage);
            document.getElementById('total-pages').textContent = totalPages;
            
            document.getElementById('prev-page').addEventListener('click', () => {
                if (currentPage > 1) {
                    showTeamPage(currentPage - 1);
                }
            });
            
            document.getElementById('next-page').addEventListener('click', () => {
                if (currentPage < totalPages) {
                    showTeamPage(currentPage + 1);
                }
            });
            
            document.getElementById('page-input').addEventListener('change', (e) => {
                const page = parseInt(e.target.value);
                if (!isNaN(page) && page >= 1 && page <= totalPages) {
                showTeamPage(page);
                } else {
                    e.target.value = currentPage;
                }
            });
            
            // Display the first page
            showTeamPage(1);
            
            // Fix the jump to team functionality
            document.getElementById('jump-to-my-team').addEventListener('click', () => {
                console.log(`Jumping to team ${myTeamNumber}`);
                
                    // Find which page the team is on
                    const myTeamIndex = currentTeams.findIndex(t => t.number === myTeamNumber);
                    
                    if (myTeamIndex >= 0) {
                        const page = Math.floor(myTeamIndex / teamsPerPage) + 1;
                        
                        // Navigate to that page
                showTeamPage(page);
                
                        // Wait for the page to update then highlight the team
                setTimeout(() => {
                            const teamRowAfterPageChange = document.getElementById(`team-row-${myTeamNumber}`);
                            
                            if (teamRowAfterPageChange) {
                                teamRowAfterPageChange.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                
                                // Flash effect
                                teamRowAfterPageChange.style.transition = 'background-color 0.3s';
                                teamRowAfterPageChange.style.backgroundColor = '#6c00ab';
                                setTimeout(() => {
                                    teamRowAfterPageChange.style.backgroundColor = '';
                                }, 500);
                    }
                }, 100);
                    } else {
                        alert(`Team ${myTeamNumber} not found in dataset`);
                }
            });
            
            // Add region filter functionality
            const regionFilter = document.getElementById('region-filter');
            regionFilter.addEventListener('change', () => {
                const selectedRegion = regionFilter.value;
                
                if (!selectedRegion) {
                    // Show all teams
                    currentTeams = sortedTeams;
                    } else {
                    // Filter by region, but always include MY_TEAM_NUMBER
                    currentTeams = sortedTeams.filter(team => 
                        team.number === MY_TEAM_NUMBER || 
                        (team.state && team.state.includes(selectedRegion)) || 
                        team.country === selectedRegion
                    );
                }
                
                // Update pagination for filtered list
                const totalPages = Math.ceil(currentTeams.length / teamsPerPage);
                document.getElementById('total-pages').textContent = totalPages;
                
                // Reset to first page with new filter
                showTeamPage(1);
            });
            
            // Set up team search functionality
            initSearchBox();
            
            // Add event listener for "Load More" button
            document.getElementById('load-more-teams')?.addEventListener('click', async () => {
                const loadBtn = document.getElementById('load-more-teams');
                loadBtn.textContent = 'Loading more teams...';
                loadBtn.disabled = true;
                
                // Get season from select element
                const season = document.getElementById('season').value;
                
                // Get existing teams
                const teamsData = getCachedTeamsData(season) || { teams: [] };
                
                // Process next batch of teams
                await processNextTeamBatch(season, teamsData.teams);
                
                // The process will update the UI when complete
            });
        }

        // Fix compareTeams function to properly load and display cached data first
        async function compareTeams(forceRefresh = false) {
            // Don't start loading if we're already loading
            if (window.isLoadingTeams) {
                debugLog("Already loading teams. Not starting a new loading process.");
                return;
            }

            comparisonContainer.innerHTML = '<div class="loading">Loading teams with OPR data...</div>';
            debugLog("Starting team comparison...");
            
            try {
                const season = seasonSelect.value;
                debugLog(`Season: ${season}`);
                
                // Check for cached data first (unless force refresh)
                const cachedData = forceRefresh ? null : getCachedTeamsData(season);
                let teamsWithStats = [];
                let apiMethod = "Unknown";

                if (cachedData && !forceRefresh) {
                    // Use cached data
                    comparisonContainer.innerHTML = `
                        <div class="loading">
                            <h3>Loading cached teams with OPR data...</h3>
                            <p>Using ${cachedData.teams.length} teams from cache</p>
                        </div>
                    `;
                    
                    teamsWithStats = cachedData.teams;
                    apiMethod = cachedData.apiMethod;
                    debugLog(`Using ${teamsWithStats.length} teams from cache`);
                    
                    // IMPORTANT: Display the cached teams FIRST before attempting to load more
                    // This ensures the UI shows the cached data immediately
                    displayTeamComparison(teamsWithStats, MY_TEAM_NUMBER, 
                        `FTC Teams with OPR Data (${teamsWithStats.length} of 16,100 teams)`);
                    
                    // Add info banner after displaying teams
                    setTimeout(() => {
                        addInfoBanner(teamsWithStats, cachedData, forceRefresh);
                    }, 100);
                    
                    // Only start automatic loading if we have some teams but not all
                    if (teamsWithStats.length > 0 && teamsWithStats.length < 5000) {
                        // Delay loading more teams to ensure UI is fully rendered
                        setTimeout(async () => {
                            if (!window.isLoadingTeams) {
                                debugLog(`Starting automatic continuation of team loading from cached point`);
                                await processNextTeamBatch(season, teamsWithStats);
                            }
                        }, 2000);
                    }
                } else {
                    // No cache or forced refresh, fetch new data with live display
                    debugLog(forceRefresh ? 
                        "Force refreshing data from API" : 
                        "No cache available, fetching new data");
                    
                    // Start fresh loading - this sets isLoadingTeams = true internally
                    window.isLoadingTeams = true;
                    const result = await fetchAllTeams(season);
                    teamsWithStats = result.teams;
                    apiMethod = result.apiMethod;
                    window.isLoadingTeams = false;
                    
                    // Cache the new results
                    cacheTeamsData(season, teamsWithStats, apiMethod);
                    
                    // Display the results
                    displayTeamComparison(teamsWithStats, MY_TEAM_NUMBER, 
                        `FTC Teams with OPR Data (${teamsWithStats.length} of 16,100 teams)`);
                
                    // Add info banner
                setTimeout(() => {
                        addInfoBanner(teamsWithStats, { timestamp: Date.now() }, forceRefresh);
                    }, 100);
                }
            } catch (error) {
                window.isLoadingTeams = false;
                debugLog(`Error: ${error.message}`);
                comparisonContainer.innerHTML = `
                    <div class="error-message">
                        <p>Error: ${error.message}</p>
                        <p>We encountered an issue retrieving the team database.</p>
                        <button id="retry-btn" class="compact-btn" style="margin-top:10px;">Retry</button>
                        ${!window.isLoadingTeams ? `
                            <button id="clear-cache-btn" class="compact-btn" style="margin-top:10px; margin-left:10px; background-color:#6b3030;">Clear Cache</button>
                            <button id="force-refresh-btn" class="compact-btn" style="margin-top:10px; margin-left:10px; background-color:#006b3a;">Force Full Refresh</button>
                        ` : ''}
                    </div>
                `;
                document.getElementById('retry-btn')?.addEventListener('click', () => compareTeams());
                document.getElementById('clear-cache-btn')?.addEventListener('click', () => {
                    localStorage.removeItem(`ftc_opr_teams_${season}`);
                    alert("Cache cleared. Retrying...");
                    compareTeams();
                });
                document.getElementById('force-refresh-btn')?.addEventListener('click', () => {
                    localStorage.removeItem(`ftc_opr_teams_${season}`);
                    alert("Force refreshing all team data...");
                    compareTeams(true);
                });
            }
        }

        // Add a helper function to add the info banner consistently
        function addInfoBanner(teamsWithStats, cachedData, forceRefresh) {
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'api-info-banner';
                    infoDiv.style.marginBottom = '10px';
                    infoDiv.style.fontSize = '0.9rem';
                    infoDiv.style.backgroundColor = '#274535';
                    infoDiv.style.padding = '8px';
                    infoDiv.style.borderRadius = '4px';
                    infoDiv.style.textAlign = 'center';
                    
                    // Add cache age information if using cached data
                    let cacheInfo = '';
                    if (cachedData && !forceRefresh) {
                        const cacheAge = Math.round((Date.now() - cachedData.timestamp) / 3600000);
                        cacheInfo = ` (cached ${cacheAge} hours ago)`;
                    }
                    
                    infoDiv.innerHTML = `
                        <div>${teamsWithStats.length} teams with OPR data available${cacheInfo}</div>
                        ${cachedData && !forceRefresh ? 
                            `<div style="font-size: 0.8rem; margin-top: 4px;">
                                <a href="#" id="clear-cache-link" style="color: #a0d8ff;">Clear cache and refresh</a>
                            </div>` : ''}
                    `;
                    
                    const container = document.querySelector('#comparison-container');
            if (container) {
                // Check if banner already exists and remove it
                const existingBanner = container.querySelector('.api-info-banner');
                if (existingBanner) {
                    existingBanner.remove();
                }
                
                // Insert the new banner at the top
                if (container.firstChild) {
                        container.insertBefore(infoDiv, container.firstChild);
                } else {
                    container.appendChild(infoDiv);
                }
                        
                        // Add event listener to the "Clear cache" link
                        document.getElementById('clear-cache-link')?.addEventListener('click', (e) => {
                            e.preventDefault();
                            const season = seasonSelect.value;
                    clearCache(season);
                            alert(`Cache cleared for season ${season}. Running full refresh...`);
                    compareTeams(true);
                });
            }
        }

        // Fix the processNextTeamBatch function to ensure proper styling and status display
        async function processNextTeamBatch(season, existingTeams) {
            if (window.isLoadingTeams) {
                debugLog('Already loading teams. Please wait for the current loading to complete.');
                return;
            }
            
            // Set the loading flag to prevent multiple processes
            window.isLoadingTeams = true;
            window.stopTeamLoading = false;
            
            try {
                debugLog(`Starting to process next team batch, continuing from existing ${existingTeams.length} teams`);
                
                // Initialize teamsMap with existing teams
                const teamsMap = new Map();
                for (const team of existingTeams) {
                    teamsMap.set(team.number, team);
                }
                
                // Load the team list
                const teamListResponse = await fetch('teamlist.txt');
                const teamListText = await teamListResponse.text();
                const lines = teamListText.split('\n').filter(line => line.trim());
                
                const allTeamNumbers = new Set();
                for (let i = 0; i < lines.length; i += 3) {
                    if (i < lines.length) {
                        const teamNumber = parseInt(lines[i], 10);
                        if (!isNaN(teamNumber)) {
                            allTeamNumbers.add(teamNumber);
                        }
                    }
                }
                
                // Get the highest team number from cache to continue from that point
                const lastProcessedTeam = existingTeams.length > 0 ? 
                    Math.max(...existingTeams.map(t => t.number)) : 0;
                
                // Filter for unprocessed teams
                const unprocessedTeamNumbers = Array.from(allTeamNumbers)
                    .filter(num => num > lastProcessedTeam)
                    .sort((a, b) => a - b);
                    
                if (unprocessedTeamNumbers.length === 0) {
                    debugLog('All teams have been processed!');
                    window.isLoadingTeams = false;
                    return;
                }

                debugLog(`Continuing from team ${lastProcessedTeam}, ${unprocessedTeamNumbers.length} teams remaining`);

                // Create the floating progress display with improved styling
                const progressDisplay = document.createElement('div');
                progressDisplay.id = 'progress-display';
                progressDisplay.style.position = 'fixed';
                progressDisplay.style.bottom = '20px';
                progressDisplay.style.right = '20px';
                progressDisplay.style.backgroundColor = '#1e1e1e';
                progressDisplay.style.border = '1px solid #444';
                progressDisplay.style.padding = '15px';
                progressDisplay.style.borderRadius = '4px';
                progressDisplay.style.zIndex = '1000';
                progressDisplay.style.boxShadow = '0 2px 10px rgba(0,0,0,0.3)';
                progressDisplay.style.minWidth = '250px';
                
                // Make sure the progress display shows the correct starting position
                const totalTeamsCount = allTeamNumbers.size;
                const startingProgress = existingTeams.length;
                
                progressDisplay.innerHTML = `
                    <div style="margin-bottom: 10px; font-weight: bold; color: #e0e0e0;">Loading More Teams...</div>
                    <progress id="batch-progress" value="${startingProgress}" max="${totalTeamsCount}" 
                        style="width:100%; margin-bottom: 8px; height: 8px; -webkit-appearance: none; appearance: none;">
                    </progress>
                    <style>
                        #batch-progress {
                            -webkit-appearance: none;
                            appearance: none;
                            background-color: #333;
                            border: none;
                            border-radius: 4px;
                            height: 8px;
                        }
                        #batch-progress::-webkit-progress-bar {
                            background-color: #333;
                            border-radius: 4px;
                        }
                        #batch-progress::-webkit-progress-value {
                            background-color: #a200ff;
                            border-radius: 4px;
                        }
                        #batch-progress::-moz-progress-bar {
                            background-color: #a200ff;
                            border-radius: 4px;
                        }
                    </style>
                    <div id="batch-status" style="font-size: 0.9em; color: #aaa;">
                        Continuing from team ${lastProcessedTeam + 1}, ${startingProgress} teams already loaded
                    </div>
                    <div id="teams-found" style="font-size: 0.9em; margin-top: 5px; color: #a200ff;">
                        ${teamsMap.size} teams with OPR data
                    </div>
                    <div id="parallel-status" style="font-size: 0.8em; margin-top: 5px; color: #888;">
                        Running parallel requests
                    </div>
                    <button id="stop-loading" style="
                        margin-top: 10px;
                        background-color: #6b3030;
                        color: white;
                        border: none;
                        padding: 5px 10px;
                        border-radius: 3px;
                        cursor: pointer;
                        width: 100%;
                    ">Stop Loading (Use Current Teams)</button>
                `;
                document.body.appendChild(progressDisplay);
                
                // Process teams in parallel with live updates
                const PARALLEL_REQUESTS = 15;
                const BATCH_SIZE = 20;
                const UPDATE_INTERVAL = 250;
                
                // Add event listener to stop button BEFORE starting processing
                const stopLoadingBtn = document.getElementById('stop-loading');
                if (stopLoadingBtn) {
                    stopLoadingBtn.addEventListener('click', () => {
                        window.stopTeamLoading = true;
                        stopLoadingBtn.textContent = 'Stopping...';
                        stopLoadingBtn.disabled = true;
                        debugLog('Stop loading requested - will complete current batch and stop');
                    });
                }

                let lastUpdateTime = Date.now();
                let processedCount = startingProgress;
                
                // Function to update the progress display
                function updateProgressDisplay() {
                    const teamsFoundEl = document.getElementById('teams-found');
                    const progressEl = document.getElementById('batch-progress');
                    const statusEl = document.getElementById('batch-status');
                    
                    if (teamsFoundEl) teamsFoundEl.textContent = `${teamsMap.size} teams with OPR data`;
                    if (progressEl) progressEl.value = processedCount;
                    if (statusEl) statusEl.textContent = 
                        `Processed ${processedCount} of ${totalTeamsCount} teams (${unprocessedTeamNumbers.length - (processedCount - startingProgress)} remaining)`;
                }

                // Process teams in batches
                for (let i = 0; i < unprocessedTeamNumbers.length; i += BATCH_SIZE * PARALLEL_REQUESTS) {
                    if (window.stopTeamLoading) {
                        debugLog('Stopping team loading as requested');
                        break;
                    }

                    const batch = unprocessedTeamNumbers.slice(i, i + BATCH_SIZE * PARALLEL_REQUESTS);
                    const promises = [];
                    const newTeams = [];

                    // Create parallel requests
                    for (let j = 0; j < PARALLEL_REQUESTS; j++) {
                        const teamNumbers = batch.filter((_, idx) => idx % PARALLEL_REQUESTS === j);
                        promises.push((async () => {
                            for (const teamNumber of teamNumbers) {
                                if (window.stopTeamLoading) break;
                                try {
                                    const result = await fetchTeamByGraphQL(teamNumber, season);
                                    if (result.stats.hasRealData) {
                                        teamsMap.set(teamNumber, result);
                                        newTeams.push(result);
                                        processedCount++;

                                        // Update progress display more frequently
                                        if (processedCount % 5 === 0) {
                                            updateProgressDisplay();
                                        }
                                    }
                                } catch (error) {
                                    if (error.message.includes('429')) {
                                        await new Promise(resolve => setTimeout(resolve, 1000));
                                        j--; // Retry this team
                                        continue;
                                    }
                                    console.error(`Error fetching team ${teamNumber}:`, error);
                                }
                            }
                        })());
                    }

                    // Wait for all parallel requests to complete
                    await Promise.all(promises);

                    // Update the display with all new teams
                    if (newTeams.length > 0) {
                        const allTeams = Array.from(teamsMap.values());
                        const now = Date.now();
                        
                        // Always update the progress display
                        updateProgressDisplay();
                        
                        // Less frequent UI updates (for performance)
                        if (now - lastUpdateTime >= UPDATE_INTERVAL) {
                            displayTeamComparison(allTeams, MY_TEAM_NUMBER, 
                                `FTC Teams with OPR Data (${allTeams.length} of ${totalTeamsCount} teams)`);
                            lastUpdateTime = now;
                        }
                        
                        // Cache periodically
                        if (i % (BATCH_SIZE * PARALLEL_REQUESTS * 2) === 0) {
                            debugLog(`Periodic cache update with ${allTeams.length} teams`);
                            cacheTeamsData(season, allTeams, "GraphQL");
                        }
                    }
                }

                // Final updates - ensure this happens even if loading is stopped
                try {
                    const finalTeams = Array.from(teamsMap.values());
                    debugLog(`Final cache update with ${finalTeams.length} teams`);
                    cacheTeamsData(season, finalTeams, "GraphQL");
                    
                    // Remove the progress display
                    const progressElement = document.getElementById('progress-display');
                    if (progressElement) {
                        progressElement.style.transition = 'opacity 0.5s';
                        progressElement.style.opacity = '0';
                        setTimeout(() => {
                            if (progressElement.parentNode) {
                                progressElement.parentNode.removeChild(progressElement);
                            }
                        }, 500);
                    }
                    
                    // Clear loading flags
                    window.isLoadingTeams = false;
                    window.stopTeamLoading = false;
                    
                    // Do a final display refresh with pagination included
                    displayTeamComparison(finalTeams, MY_TEAM_NUMBER, 
                        `FTC Teams with OPR Data (${finalTeams.length} of ${totalTeamsCount} teams)`);
                    
                    return finalTeams;
                } catch (cacheError) {
                    debugLog(`Error during final cache: ${cacheError.message}`);
                    window.isLoadingTeams = false;
                    window.stopTeamLoading = false;
                    
                    const teams = Array.from(teamsMap.values());
                    displayTeamComparison(teams, MY_TEAM_NUMBER, 
                        `FTC Teams with OPR Data (${teams.length} of ${totalTeamsCount} teams)`);
                    
                    return teams; // Return teams even if caching fails
                }
            } catch (error) {
                // Clean up on error
                window.isLoadingTeams = false;
                window.stopTeamLoading = false;
                
                // Remove the progress display if there's an error
                const progressElement = document.getElementById('progress-display');
                if (progressElement && progressElement.parentNode) {
                    progressElement.parentNode.removeChild(progressElement);
                }
                
                debugLog(`Error processing batch: ${error.message}`);
                alert(`Error loading more teams: ${error.message}`);
                return existingTeams; // Return the original teams on error
            }
        }

        // Fix the team search functionality
        document.addEventListener('DOMContentLoaded', () => {
            // Make sure any previously bound event listeners don't interfere
            document.getElementById('compare-btn').addEventListener('click', function() {
                compareTeams();
            });
            
            // Initialize the season select with the current season if needed
            // But do NOT call setupUI()
        });

        // Fix search input and ensure it works
        function initSearchBox() {
            const searchInput = document.getElementById('team-search');
            const searchBtn = document.getElementById('search-btn');
            
            if (searchInput && searchBtn) {
                // Clear any previous event listeners
                searchInput.removeEventListener('keypress', handleSearchKey);
                searchBtn.removeEventListener('click', handleSearch);
                
                // Add new event listeners
                searchInput.addEventListener('keypress', handleSearchKey);
                searchBtn.addEventListener('click', handleSearch);
                
                // Ensure the input is not disabled
                searchInput.disabled = false;
                
                // Add focus to make it obvious it's editable
                searchInput.style.cursor = 'text';
            }
        }

        function handleSearchKey(e) {
            if (e.key === 'Enter') {
                handleSearch();
            }
        }

        function handleSearch() {
            const searchInput = document.getElementById('team-search');
            const teamNumber = parseInt(searchInput.value);
            
            if (isNaN(teamNumber)) {
                alert('Please enter a valid team number');
                return;
            }
            
            // Find the team row
            const teamRow = document.getElementById(`team-row-${teamNumber}`);
            
            if (teamRow) {
                // Clear other highlights
                document.querySelectorAll('.team-row').forEach(row => {
                    row.classList.remove('highlighted');
                });
                
                // Highlight this team
                teamRow.classList.add('highlighted');
                teamRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Flash effect
                teamRow.style.transition = 'background-color 0.3s';
                teamRow.style.backgroundColor = '#6c00ab';
                setTimeout(() => {
                    teamRow.style.backgroundColor = '';
                }, 500);
            } else {
                alert(`Team ${teamNumber} not found`);
            }
        }
        
        // Modified main UI with comprehensive region dropdown
        function setupUI() {
            // This function should not be used or should be modified to only use region codes
            console.log("setupUI disabled to prevent full names in dropdown");
        }

        // Add caching system for faster loads
        const CACHE_VERSION = 1;

        // Improved caching system to ensure teams are properly saved
        function cacheTeamsData(season, teams, apiMethod) {
            console.log(`Attempting to cache ${teams.length} teams for season ${season}`);
            try {
                const currentTime = Date.now();
                
                // Add timestamps to teams that don't have them
                const teamsWithTimestamps = teams.map(team => ({
                    ...team,
                    cachedAt: team.cachedAt || currentTime
                }));
                
                const cacheData = {
                    version: CACHE_VERSION,
                    timestamp: currentTime,
                    apiMethod: apiMethod,
                    season: season
                };
                
                // Split the cache into smaller chunks for reliability
                const MAX_CHUNK_SIZE = 200; // Smaller chunks to avoid storage limits
                const chunks = [];
                
                for (let i = 0; i < teamsWithTimestamps.length; i += MAX_CHUNK_SIZE) {
                    const chunk = teamsWithTimestamps.slice(i, i + MAX_CHUNK_SIZE);
                    chunks.push(chunk);
                }
                
                // Store metadata about chunks
                const cacheMetadata = {
                    season: season,
                    version: CACHE_VERSION,
                    timestamp: currentTime,
                    totalTeams: teamsWithTimestamps.length,
                    chunks: chunks.length,
                    apiMethod: apiMethod
                };
                
                // Store the metadata
                try {
                    localStorage.setItem(`ftc_opr_teams_${season}_metadata`, JSON.stringify(cacheMetadata));
                    console.log(`Stored cache metadata: ${chunks.length} chunks, ${teamsWithTimestamps.length} teams`);
                } catch (e) {
                    console.error(`Failed to store cache metadata: ${e.message}`);
                }
                
                // Store each chunk separately with retry logic
                let successfulChunks = 0;
                for (let i = 0; i < chunks.length; i++) {
                    const chunkData = {
                        ...cacheData,
                        teams: chunks[i],
                        chunkIndex: i,
                        totalChunks: chunks.length
                    };
                    
                    try {
                        const chunkKey = `ftc_opr_teams_${season}_chunk_${i}`;
                        const chunkJson = JSON.stringify(chunkData);
                        localStorage.setItem(chunkKey, chunkJson);
                        successfulChunks++;
                        
                        // Verify the data was saved properly
                        const savedData = localStorage.getItem(chunkKey);
                        if (!savedData || savedData.length < 10) {
                            throw new Error(`Chunk ${i} wasn't saved properly`);
                        }
                    } catch (storageError) {
                        console.error(`Error storing chunk ${i}: ${storageError.message}`);
                        // If we fail a chunk, try a smaller chunk size for that portion
                        if (MAX_CHUNK_SIZE > 50 && chunks[i].length > 50) {
                            console.log(`Trying to save chunk ${i} with smaller size`);
                            const smallerChunks = [];
                            const problematicChunk = chunks[i];
                            for (let j = 0; j < problematicChunk.length; j += 50) {
                                const miniChunk = problematicChunk.slice(j, j + 50);
                                const miniChunkData = {
                                    ...cacheData,
                                    teams: miniChunk,
                                    chunkIndex: `${i}_${j/50}`,
                                    isSubChunk: true,
                                    parentChunk: i,
                                    totalChunks: chunks.length
                                };
                                try {
                                    localStorage.setItem(`ftc_opr_teams_${season}_subchunk_${i}_${j/50}`, JSON.stringify(miniChunkData));
                                    successfulChunks += 0.2; // Count partial success
                                    console.log(`Saved subchunk ${i}_${j/50}`);
                                } catch (e) {
                                    console.error(`Failed to save even smaller chunk: ${e.message}`);
                                }
                            }
                        }
                    }
                }
                
                // Update the count of chunks we successfully stored
                try {
                    localStorage.setItem(`ftc_opr_teams_${season}_successful_chunks`, successfulChunks.toString());
                    console.log(`Successfully cached ${Math.floor(successfulChunks)} full chunks and ${(successfulChunks % 1) * 5} subchunks for season ${season}`);
                } catch (e) {
                    console.error(`Failed to update successful chunks count: ${e.message}`);
                }
                
                // Let the user know the cache was updated
                const teamsCount = teams.length;
                const cachingResult = document.createElement('div');
                cachingResult.style.padding = '10px';
                cachingResult.style.margin = '10px 0';
                cachingResult.style.backgroundColor = '#274535';
                cachingResult.style.borderRadius = '4px';
                cachingResult.style.color = '#e0e0e0';
                cachingResult.style.textAlign = 'center';
                cachingResult.innerHTML = `
                    <div style="font-weight: bold;">Cache Updated</div>
                    <div>Successfully saved ${teamsCount} teams to browser storage</div>
                `;
                comparisonContainer.insertBefore(cachingResult, comparisonContainer.firstChild);
                
                // Auto-remove the notification after 5 seconds
                setTimeout(() => {
                    if (cachingResult.parentNode) {
                        cachingResult.parentNode.removeChild(cachingResult);
                    }
                }, 5000);
                
                return true;
            } catch (e) {
                console.error(`Error in cache saving system: ${e.message}`);
                return false;
            }
        }

        // Improved cache retrieval to handle partial or corrupted cache
        function getCachedTeamsData(season) {
            console.log(`Attempting to load cached teams for season ${season}`);
            try {
                // Check if we have metadata about the cache
                const metadataJson = localStorage.getItem(`ftc_opr_teams_${season}_metadata`);
                if (!metadataJson) {
                    console.log(`No cache metadata found for season ${season}`);
                    return null;
                }
                
                const metadata = JSON.parse(metadataJson);
                console.log(`Found cache metadata: ${metadata.chunks} chunks, ${metadata.totalTeams} total teams`);
                
                // Check if the metadata is for the current cache version
                if (metadata.version !== CACHE_VERSION) {
                    console.log(`Cache version mismatch: ${metadata.version} vs ${CACHE_VERSION}`);
                    clearCache(season);
                    return null;
                }
                
                // Get how many chunks we successfully stored
                const successfulChunksStr = localStorage.getItem(`ftc_opr_teams_${season}_successful_chunks`);
                const successfulChunks = successfulChunksStr ? parseFloat(successfulChunksStr) : 0;
                console.log(`We have ${Math.floor(successfulChunks)} full chunks and ${(successfulChunks % 1) * 5} subchunks`);
                
                // Read all chunks
                const allTeams = [];
                let apiMethod = metadata.apiMethod || "Unknown";
                let timestamp = metadata.timestamp || Date.now();
                let chunksLoaded = 0;
                
                // First try regular chunks
                for (let i = 0; i < metadata.chunks; i++) {
                    const chunkData = localStorage.getItem(`ftc_opr_teams_${season}_chunk_${i}`);
                    if (chunkData) {
                        try {
                            const chunk = JSON.parse(chunkData);
                            allTeams.push(...chunk.teams);
                            chunksLoaded++;
                            console.log(`Loaded chunk ${i} with ${chunk.teams.length} teams`);
                        } catch (e) {
                            console.error(`Error parsing chunk ${i}: ${e.message}`);
                            
                            // Try to load subchunks if the main chunk failed
                            let subchunksLoaded = 0;
                            for (let j = 0; j < 10; j++) { // Try up to 10 subchunks per chunk
                                const subchunkData = localStorage.getItem(`ftc_opr_teams_${season}_subchunk_${i}_${j}`);
                                if (subchunkData) {
                                    try {
                                        const subchunk = JSON.parse(subchunkData);
                                        allTeams.push(...subchunk.teams);
                                        subchunksLoaded++;
                                        console.log(`Loaded subchunk ${i}_${j} with ${subchunk.teams.length} teams`);
                                    } catch (subErr) {
                                        console.error(`Error parsing subchunk ${i}_${j}: ${subErr.message}`);
                                    }
                                }
                            }
                            console.log(`Loaded ${subchunksLoaded} subchunks for failed chunk ${i}`);
                        }
                    } else {
                        console.log(`Chunk ${i} not found`);
                    }
                }
                
                // Remove duplicates by team number
                const uniqueTeamsMap = new Map();
                for (const team of allTeams) {
                    if (team && team.number) {
                        // Keep the most recent version of each team
                        if (!uniqueTeamsMap.has(team.number) || 
                            (team.cachedAt && uniqueTeamsMap.get(team.number).cachedAt < team.cachedAt)) {
                            uniqueTeamsMap.set(team.number, team);
                        }
                    }
                }
                
                const uniqueTeams = Array.from(uniqueTeamsMap.values());
                console.log(`Loaded ${chunksLoaded} chunks with ${uniqueTeams.length} unique teams`);
                
                // Create a success message to show the user
                const loadSuccessMsg = document.createElement('div');
                loadSuccessMsg.style.padding = '10px';
                loadSuccessMsg.style.margin = '10px 0';
                loadSuccessMsg.style.backgroundColor = '#274535';
                loadSuccessMsg.style.borderRadius = '4px';
                loadSuccessMsg.style.color = '#e0e0e0';
                loadSuccessMsg.style.textAlign = 'center';
                loadSuccessMsg.innerHTML = `
                    <div style="font-weight: bold;">Cache Loaded</div>
                    <div>Successfully loaded ${uniqueTeams.length} teams from cache</div>
                `;
                comparisonContainer.insertBefore(loadSuccessMsg, comparisonContainer.firstChild);
                
                // Auto-remove the notification after 5 seconds
                setTimeout(() => {
                    if (loadSuccessMsg.parentNode) {
                        loadSuccessMsg.parentNode.removeChild(loadSuccessMsg);
                    }
                }, 5000);
                
                return {
                    version: CACHE_VERSION,
                    timestamp: timestamp,
                    teams: uniqueTeams,
                    apiMethod: apiMethod,
                    season: season
                };
            } catch (e) {
                console.error(`Error reading cache: ${e.message}`);
                return null;
            }
        }

        // More thorough cache clearing
        function clearCache(season) {
            console.log(`Clearing cache for season ${season}`);
            try {
                // Clear all metadata
                localStorage.removeItem(`ftc_opr_teams_${season}_metadata`);
                localStorage.removeItem(`ftc_opr_teams_${season}_successful_chunks`);
                
                // Clear both regular chunks and subchunks
                for (let i = 0; i < 200; i++) { // Try up to 200 chunks
                    localStorage.removeItem(`ftc_opr_teams_${season}_chunk_${i}`);
                    
                    // Also clear potential subchunks
                    for (let j = 0; j < 10; j++) {
                        localStorage.removeItem(`ftc_opr_teams_${season}_subchunk_${i}_${j}`);
                    }
                }
                
                // Clear any old format cache
                localStorage.removeItem(`ftc_opr_teams_${season}`);
                localStorage.removeItem(`ftc_opr_teams_${season}_chunks`);
                
                console.log(`Successfully cleared all cache data for season ${season}`);
                
                // Show confirmation to user
                const clearMsg = document.createElement('div');
                clearMsg.style.padding = '10px';
                clearMsg.style.margin = '10px 0';
                clearMsg.style.backgroundColor = '#6b3030';
                clearMsg.style.borderRadius = '4px';
                clearMsg.style.color = '#e0e0e0';
                clearMsg.style.textAlign = 'center';
                clearMsg.innerHTML = `
                    <div style="font-weight: bold;">Cache Cleared</div>
                    <div>Successfully removed all cached data for season ${season}</div>
                `;
                comparisonContainer.insertBefore(clearMsg, comparisonContainer.firstChild);
                
                // Auto-remove the notification after 5 seconds
                setTimeout(() => {
                    if (clearMsg.parentNode) {
                        clearMsg.parentNode.removeChild(clearMsg);
                    }
                }, 5000);
                
                return true;
            } catch (e) {
                console.error(`Error clearing cache: ${e.message}`);
                return false;
            }
        }

        // Add an emergency cache all function that can be called from console
        window.saveCurrentTeams = function() {
            const season = document.getElementById('season').value;
            
            // Get all team elements from the DOM
            const teamRows = document.querySelectorAll('.team-row');
            const teams = [];
            
            for (const row of teamRows) {
                const teamNumber = parseInt(row.getAttribute('data-team'));
                if (!isNaN(teamNumber)) {
                    // Extract team data from the DOM
                    const teamName = row.querySelector('.team-name')?.textContent || `Team ${teamNumber}`;
                    const location = row.querySelector('.team-location')?.textContent || '';
                    const oprText = row.querySelector('.team-opr')?.textContent || '0';
                    const opr = parseFloat(oprText) || 0;
                    
                    // Parse location
                    const locationParts = location.split(',').map(part => part.trim());
                    const city = locationParts[0] || '';
                    const state = locationParts.length > 1 ? locationParts[1] : '';
                    const country = locationParts.length > 2 ? locationParts[2] : 'USA';
                    
                    teams.push({
                        number: teamNumber,
                        name: teamName,
                        city: city,
                        state: state,
                        country: country,
                        cachedAt: Date.now(),
                        stats: {
                            opr: opr,
                            hasRealData: opr > 0
                        }
                    });
                }
            }
            
            console.log(`Extracted ${teams.length} teams from current display`);
            
            if (teams.length > 0) {
                // Cache the teams
                cacheTeamsData(season, teams, "EmergencySave");
                return `Successfully saved ${teams.length} teams to cache`;
            } else {
                return "No teams found to save";
            }
        };

        // Update the fetchAllTeams function to use parallel processing
        async function fetchAllTeams(season) {
            debugLog(`Fetching comprehensive team data for season ${season}`);
            let apiMethodUsed = "GraphQL";
            
            // Create initial display structure
            comparisonContainer.innerHTML = `
                <div id="live-teams-display">
                    <div class="team-list-header">
                        <div class="header-rank">Rank</div>
                        <div class="header-number">Team</div>
                        <div class="header-name">Name</div>
                        <div class="header-location">Location</div>
                        <div class="header-opr">OPR</div>
                        <div class="header-bar">Performance</div>
                    </div>
                    <div class="teams-list" id="teams-list-live" style="max-height: 600px; overflow-y: auto;"></div>
                </div>
            `;

            // Create the floating progress display
            const progressDisplay = document.createElement('div');
            progressDisplay.style.position = 'fixed';
            progressDisplay.style.bottom = '20px';
            progressDisplay.style.right = '20px';
            progressDisplay.style.backgroundColor = '#1e1e1e';
            progressDisplay.style.border = '1px solid #444';
            progressDisplay.style.padding = '15px';
            progressDisplay.style.borderRadius = '4px';
            progressDisplay.style.zIndex = '1000';
            progressDisplay.style.boxShadow = '0 2px 10px rgba(0,0,0,0.3)';
            progressDisplay.style.minWidth = '250px';
            progressDisplay.innerHTML = `
                <div style="margin-bottom: 10px;">Loading FTC Teams...</div>
                <progress id="loading-progress" style="width:100%; margin-bottom: 8px;"></progress>
                <div id="loading-status" style="font-size: 0.9em; color: #aaa;">Starting data retrieval...</div>
                <div id="teams-found" style="font-size: 0.9em; margin-top: 5px; color: #a200ff;">
                    0 teams with OPR data found
                </div>
                <div id="parallel-status" style="font-size: 0.8em; margin-top: 5px; color: #888;">
                    Running 15 parallel requests
                </div>
                <button id="stop-loading" style="
                    margin-top: 10px;
                    background-color: #6b3030;
                    color: white;
                    border: none;
                    padding: 5px 10px;
                    border-radius: 3px;
                    cursor: pointer;
                    width: 100%;
                ">Stop Loading (Use Current Teams)</button>
            `;
            document.body.appendChild(progressDisplay);

            // Use a Map to track unique teams
            const teamsMap = new Map();
            
            // Update UI elements
            const progressEl = document.getElementById('loading-progress');
            const statusEl = document.getElementById('loading-status');
            const teamsFoundEl = document.getElementById('teams-found');
            const parallelStatusEl = document.getElementById('parallel-status');
            const stopLoadingBtn = document.getElementById('stop-loading');
            
            let stopLoading = false;
            stopLoadingBtn.addEventListener('click', () => {
                stopLoading = true;
                stopLoadingBtn.textContent = 'Stopping after current batch...';
                stopLoadingBtn.disabled = true;
            });

            try {
                // Load and parse teamlist.txt
                const teamListResponse = await fetch('teamlist.txt');
                if (!teamListResponse.ok) {
                    throw new Error(`Could not load teamlist.txt: ${teamListResponse.status}`);
                }
                
                const teamListText = await teamListResponse.text();
                const lines = teamListText.split('\n').filter(line => line.trim());
                const teamNumbers = new Set();
                
                for (let i = 0; i < lines.length; i += 3) {
                    if (i < lines.length) {
                        const teamNumber = parseInt(lines[i], 10);
                        if (!isNaN(teamNumber)) {
                            teamNumbers.add(teamNumber);
                        }
                    }
                }
                
                const uniqueTeamNumbers = Array.from(teamNumbers);
                debugLog(`Extracted ${uniqueTeamNumbers.length} unique team numbers from teamlist.txt`);
                
                // Set up progress tracking
                if (progressEl) progressEl.max = uniqueTeamNumbers.length;
                let processedCount = 0;

                // Parallel processing configuration
                const PARALLEL_REQUESTS = 15; // Number of parallel requests
                const BATCH_SIZE = 50; // Teams per parallel worker
                const RATE_LIMIT_DELAY = 100; // Delay between batches in ms

                // Create a rate-limited fetch function
                const rateLimitedFetch = async (teamNumber) => {
                    try {
                        const result = await fetchTeamByGraphQL(teamNumber, season);
                        if (result.stats.hasRealData) {
                            teamsMap.set(teamNumber, result);
                            
                            // Get the live display element
                            const teamsListEl = document.getElementById('teams-list-live');
                            if (teamsListEl) {
                                // Get all current teams and sort them
                                const allTeams = Array.from(teamsMap.values());
                                const sortedTeams = [...allTeams].sort((a, b) => b.stats.opr - a.stats.opr);
                                const maxOPR = Math.max(...sortedTeams.map(t => t.stats.opr));
                                
                                // Generate HTML for all teams
                                const teamsHTML = sortedTeams.map((team, index) => {
                                    const rank = index + 1;
                                    const isMyTeam = team.number === MY_TEAM_NUMBER;
                                    const opr = team.stats.opr.toFixed(1);
                                    const percentage = (team.stats.opr / maxOPR) * 100;
                                    const location = [team.city, team.state, team.country].filter(Boolean).join(', ');
                                    const isNew = team.number === result.number;
                                    
                                    return `
                                        <div class="team-row ${isMyTeam ? 'highlighted' : ''} ${isNew ? 'new-team' : ''}" 
                                            id="team-row-${team.number}" 
                                            data-team="${team.number}">
                                            <div class="team-rank">${rank}</div>
                                            <div class="team-number">#${team.number}</div>
                                            <div class="team-name">${team.name}</div>
                                            <div class="team-location">${location}</div>
                                            <div class="team-opr">${opr}</div>
                                            <div class="opr-bar-container">
                                                <div class="opr-bar" style="width: ${percentage}%"></div>
                                            </div>
                                        </div>
                                    `;
                                }).join('');
                                
                                teamsListEl.innerHTML = teamsHTML;
                            }
                        }
                        return result;
                    } catch (error) {
                        if (error.message.includes('429')) {
                            // If rate limited, wait longer and retry
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            return rateLimitedFetch(teamNumber);
                        }
                        throw error;
                    }
                };

                // Process teams in parallel workers
                const processTeamsParallel = async (teamNumbers) => {
                    const chunks = [];
                    for (let i = 0; i < teamNumbers.length; i += BATCH_SIZE * PARALLEL_REQUESTS) {
                        if (stopLoading) break;
                        
                        const currentChunk = teamNumbers.slice(i, i + BATCH_SIZE * PARALLEL_REQUESTS);
                        const workers = [];
                        
                        // Split the chunk into parallel workers
                        for (let j = 0; j < PARALLEL_REQUESTS; j++) {
                            const workerTeams = currentChunk.slice(j * BATCH_SIZE, (j + 1) * BATCH_SIZE);
                            if (workerTeams.length === 0) continue;
                            
                            workers.push((async () => {
                                for (const teamNumber of workerTeams) {
                                    if (stopLoading) break;
                                    if (teamsMap.has(teamNumber)) continue;
                                    
                                    await rateLimitedFetch(teamNumber);
                                    processedCount++;
                                    
                                    // Update UI
                                    if (progressEl) progressEl.value = processedCount;
                                    if (statusEl) statusEl.textContent = 
                                        `Processed ${processedCount} of ${teamNumbers.length} teams`;
                                    if (teamsFoundEl) teamsFoundEl.textContent = 
                                        `${teamsMap.size} teams with OPR data found`;
                                }
                            })());
                        }
                        
                        // Wait for all workers in this chunk to complete
                        await Promise.all(workers);
                        
                        // Rate limiting between chunks
                        if (!stopLoading && i + BATCH_SIZE * PARALLEL_REQUESTS < teamNumbers.length) {
                            await new Promise(resolve => setTimeout(resolve, RATE_LIMIT_DELAY));
                        }
                        
                        // Update parallel status
                        if (parallelStatusEl) {
                            const activeWorkers = Math.min(
                                PARALLEL_REQUESTS,
                                Math.ceil((teamNumbers.length - i) / BATCH_SIZE)
                            );
                            parallelStatusEl.textContent = 
                                `Running ${activeWorkers} parallel request${activeWorkers !== 1 ? 's' : ''}`;
                        }
                    }
                };

                // Start parallel processing
                await processTeamsParallel(uniqueTeamNumbers);
                
                // Remove the progress display after completion or if stopped
                setTimeout(() => {
                    progressDisplay.style.transition = 'opacity 0.5s';
                    progressDisplay.style.opacity = '0';
                    setTimeout(() => document.body.removeChild(progressDisplay), 500);
                }, 2000);
                
            } catch (error) {
                debugLog(`Error in team loading: ${error.message}`);
                // ... existing fallback logic ...
            }
            
            const teamsWithOPR = Array.from(teamsMap.values());
            return {
                teams: teamsWithOPR,
                apiMethod: apiMethodUsed
            };
        }

        // Update the updateTeamsDisplay function to be more efficient
        function updateTeamsDisplay(newTeams) {
            const teamsListEl = document.getElementById('teams-list-live');
            if (!teamsListEl) return;
            
            // Get all current teams and add new ones
            const allTeams = Array.from(teamsMap.values());
            
            // Sort by OPR highest to lowest
            const sortedTeams = [...allTeams].sort((a, b) => b.stats.opr - a.stats.opr);
            
            // Calculate max OPR for scaling the bars
            const maxOPR = Math.max(...sortedTeams.map(t => t.stats.opr));
            
            // Create HTML for all teams
            const teamsHTML = sortedTeams.map((team, index) => {
                const rank = index + 1;
                const isMyTeam = team.number === MY_TEAM_NUMBER;
                const opr = team.stats.opr.toFixed(1);
                const percentage = (team.stats.opr / maxOPR) * 100;
                const location = [team.city, team.state, team.country].filter(Boolean).join(', ');
                
                return `
                    <div class="team-row ${isMyTeam ? 'highlighted' : ''}" 
                        id="team-row-${team.number}" 
                        data-team="${team.number}"
                        ${newTeams.includes(team) ? 'style="animation: fadeIn 0.5s;"' : ''}>
                        <div class="team-rank">${rank}</div>
                        <div class="team-number">#${team.number}</div>
                        <div class="team-name">${team.name}</div>
                        <div class="team-location">${location}</div>
                        <div class="team-opr">${opr}</div>
                        <div class="opr-bar-container">
                            <div class="opr-bar" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
            
            teamsListEl.innerHTML = teamsHTML;
        }

        // Improve fetchTeamByGraphQL with the correct region parameter
        async function fetchTeamByGraphQL(teamNumber, season) {
                try {
                    const graphqlUrl = 'https://api.ftcscout.org/graphql';
                // Optimized query - only request the exact fields we need
                const query = `{
                    teamByNumber(number: ${teamNumber}) {
                                number
                                name
                                location {
                                    city
                                    state
                                    country
                                }
                        quickStats(season: ${season}, region: All) {
                            tot {
                                value
                                rank
                            }
                            }
                        }
                    }`;
                    
                    const response = await fetch(graphqlUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        'Accept': 'application/json'
                        },
                        body: JSON.stringify({ query })
                    });
                    
                if (!response.ok) {
                    throw new Error(`GraphQL error: ${response.status}`);
                }
                    
                    const result = await response.json();
                    
                if (result.errors) {
                    throw new Error(`GraphQL errors: ${JSON.stringify(result.errors)}`);
                }
                
                const teamData = result.data?.teamByNumber;
                
                if (!teamData) {
                    throw new Error(`Team ${teamNumber} not found`);
                }
                
                const oprValue = teamData.quickStats?.tot?.value || 0;
                
                return {
                    number: teamNumber,
                    name: teamData.name || `Team ${teamNumber}`,
                    city: teamData.location?.city || '',
                    state: teamData.location?.state || '',
                    country: teamData.location?.country || '',
                    stats: {
                        opr: oprValue,
                        rank: teamData.quickStats?.tot?.rank || null,
                        hasRealData: oprValue > 0
                    }
                };
            } catch (error) {
                throw error;
            }
        }

        // Remove the background loading since we're loading all teams upfront
        function startBackgroundLoading(season) {
            // This function is now empty since we load all teams upfront
            debugLog("Background loading not needed - all teams loaded initially");
        }

        // Manual emergency stop
        (function() {
            // Reset loading flags
            window.isLoadingTeams = false;
            window.stopTeamLoading = true;
            
            // Find and remove progress display
            const progressDisplay = document.getElementById('progress-display');
            if (progressDisplay && progressDisplay.parentNode) {
                progressDisplay.parentNode.removeChild(progressDisplay);
            }
        })();
    </script>
</body>
</html>
